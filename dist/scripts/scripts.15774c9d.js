"use strict";angular.module("cdumpApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","chart.js"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",controllerAs:"main"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).otherwise({redirectTo:"/"}),b.hashPrefix("")}]),angular.module("cdumpApp").controller("MainCtrl",["$scope",function(a){a.parsedData=[{title:"How it works",desc:"You select the CSV file generated by Translink. Then, cdump will process it and tell you some useful and fun things about your transit usage. All of your data is kept entirely private and never leaves your computer.",items:[]}],a.parserHasRun=!1,a.showSpinner=!1,a.file_changed=function(b){a.showSpinner=!0,a.$apply(),Papa.parse(b.files[0],{header:!0,dynamicTyping:!0,complete:function(b){console.log(b);for(var c,d,e=b.data,f=0,g=0,h=moment(e[0].DateTime),i=[],j={},k={},l={},m=0;m<e.length;m++)if(void 0!==e[m].Amount){if(f+=e[m].Amount,g++,c=e[m].DateTime,i.push(moment(e[m].DateTime)),e[m].Transaction.indexOf(" at ")>=0){var n=e[m].Transaction.split(" at ")[0].trim();null==j[n]&&(j[n]=0),j[n]++;var o=e[m].Transaction.split(" at ")[1].replace("Bus Stop","").trim();null==k[o]&&(k[o]=0),k[o]++}if("Loaded"!==n){var p=e[m].Location;null==l[p]&&(l[p]=0),l[p]++}}c=moment(c),console.log(k),d=moment.duration(h.diff(c)),a.parsedData.length=0,a.parsedData.push({title:"Total time",desc:"To calculate averages, the total time of your compass card is used. To determine this, I calculate the time between first and last valid events in the CSV. If you started using your compass card a few months after the first event, you should generate a CSV that starts when you start actively using it.",items:[{title:"Most recent usage",value:h.fromNow()},{title:"Oldest usage",value:c.fromNow()},{title:"Total time used",value:d.humanize()}]});var q=[{title:"Total transactions",value:g+" (~"+Math.round(g/d.asMonths())+" a month/~"+Math.round(g/d.asWeeks())+" a week/~"+Math.round(g/d.asDays())+" a day)"}];for(n in j)j.hasOwnProperty(n)&&q.push({title:n,value:j[n]+" (~"+Math.round(j[n]/d.asMonths())+" a month)"});a.parsedData.push({title:"Transactions by type",desc:"Translink's dumps are a list of transaction, these almost always follow a tap of your card. cdump dynamically detects transaction types.",items:q});var r=[];for(var s in k)r.push([s,k[s]]);r.sort(function(a,b){return b[1]-a[1]});var t="";for(m=0;m<Math.min(r.length,9);m++)t+=r[m][0]+"("+r[m][1]+"), ";t=t.trim().slice(0,-1),a.parsedData.push({title:"Transactions by location",desc:'I have determined the location of each of your taps by parsing the "Transaction" field of each entry. Locations are either bus stops or stations. Bus stops are left as numerical ids.',items:[{title:"Total unqiue stops",value:r.length},{title:"Top 10 locations by amount of taps",value:t}]}),0==f?a.parsedData.push({title:"Money Spent",desc:'To calculate money spent, I take the sum of the "Amount" on all your taps.',items:[{title:"Total money spent",value:f},{title:"You spent no money in the time frame, so no further calculations were made."}]}):a.parsedData.push({title:"Money Spent",desc:'To calculate money spent, I take the sum of the "Amount" on all your taps.',items:[{title:"Total money spent",value:f},{title:"Money per month",value:f/d.asMonths()},{title:"Money per week",value:f/d.asWeeks()},{title:"Money per day",value:f/d.asDays()}]});var u=[],v=[],w=[],x=[];for(var y in l)if(l.hasOwnProperty(y)){var z=y.indexOf("-");-1!=z&&5>=z&&!isNaN(y.split("-")[0])?(v.push(y),u.push(l[y])):(x.push(y),w.push(l[y]))}a.parsedData.push({title:"Transactions by bus route",desc:"",isChart:!0,chartType:"pie",chartData:u,chartLabels:v}),a.parsedData.push({title:"Transactions by station",desc:"",isChart:!0,chartType:"pie",chartData:w,chartLabels:x});var A=[];for(m=0;m<i.length;m++){for(var B=!1,C=0;C<A.length;C++)if(A[C].x==i[m].format("MMM YYYY")){A[C].y++,B=!0;break}B||A.push({x:i[m].format("MMM YYYY"),y:1})}a.parsedData.push({title:"Transactions per month",desc:"",isChart:!0,chartType:"line",chartData:[A],chartOptions:{scales:{xAxes:[{type:"time",time:{unit:"month"}}]}},chartOverride:[{fill:!1,label:"Transactions",lineTension:0}]}),a.showSpinner=!1,a.parserHasRun=!0,a.$apply()}})}}]),angular.module("cdumpApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("cdumpApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/main.html",'<div class="jumbotron"> <h1>Hello!</h1> <p class="lead"> This app can analyse your CSV compass card dump. </p> <h4><input ng-model="file" onchange="angular.element(this).scope().file_changed(this)" type="file" accept=".csv"></h4> </div> <div class="row marketing"> <p ng-show="showSpinner">Parsing file......</p> <p ng-show="parserHasRun">PARSED!</p> <div ng-repeat="dataItem in parsedData"> <div class="panel panel-default"> <div class="panel-heading"> <h3 class="panel-title" ng-bind="dataItem.title"></h3> </div> <div class="panel-body"> <p ng-bind="dataItem.desc"></p> <ul> <li ng-repeat="item in dataItem.items"> <b ng-bind="item.title"></b>: <span ng-bind="item.value"></span> </li> </ul> <canvas ng-show="dataItem.isChart" id="dataItem.chartId" class="chart-base" chart-type="dataItem.chartType" chart-data="dataItem.chartData" chart-labels="dataItem.chartLabels" chart-options="dataItem.chartOptions" chart-dataset-override="dataItem.chartOverride"> </canvas> </div> </div> </div> </div>')}]);